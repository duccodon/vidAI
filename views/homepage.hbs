<div
  class="fixed top-[3.8rem] sm:top-[5.4rem] left-[100px] h-[calc(100vh-5*1vh-3.8rem)] sm:h-[calc(100vh-5*1vh-7rem)] md:h-[calc(100vh-5*1vh-2rem)] w-[100%] md:w-[93%] bg-white rounded-[1rem] border border-[#ccc] overflow-y-auto overflow-x-hidden z-3">
  <div id="firstPage" class="mx-4 my-auto items-center gap-[1rem] py-[1rem] md:flex hidden">
    <img src="data:image/jpeg;base64,{{currentUser.profile_picture}}"
      class="min-w-[2.5rem] min-h-[2.5rem] max-w-[2.5rem] max-h-[2.5rem] rounded-[50%] overflow-hidden" />
    <div class="flex flex-row gap-4 items-start md:items-center w-full">
      <textarea id="insertTopic"
        class="flex-grow w-full md:w-auto pl-4 text-[13px] bg-[#FAFAFA] rounded-[2rem] px-[.5rem] py-[.5rem]"
        placeholder="What's on your mind?" rows="1"
        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px';"></textarea>
      <div class="flex flex-wrap gap-4 items-center text-[13px]">
        <label class="flex items-center gap-1">
          <input type="radio" name="duration" value="1 min" class="accent-black" checked />
          <span>Short (1 min)</span>
        </label>
        <label class="flex items-center gap-1">
          <input type="radio" name="duration" value="3 min" class="accent-black" />
          <span>Medium (3 min)</span>
        </label>
        <label class="flex items-center gap-1">
          <input type="radio" name="duration" value="5 min+" class="accent-black" />
          <span>Long (5 min+)</span>
        </label>
      </div>
    </div>
    <div id="postButton"
      class="plus-button inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem]">
      Next
    </div>
  </div>


  <!-- Section to choose bot and style -->
  <div
    class="fixed top-[3.8rem] sm:top-[5.4rem] left-[100px] h-[calc(100vh-5*1vh-3.8rem)] sm:h-[calc(100vh-5*1vh-7rem)] md:h-[calc(100vh-5*1vh-2rem)] w-[100%] md:w-[93%] bg-white rounded-[1rem] border border-[#ccc] overflow-y-auto overflow-x-hidden z-3"
    id="secondPage" style="display: none;">
    <div class="flex flex-row justify-between mx-4 my-auto gap-[3rem] py-[1rem]">
      <div class="flex items-center">
        <div id="returnTopicBtn"
          class="inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem] mt-4">
          Back
        </div>
      </div>

      <div>
        <div class="text-[20px] font-medium">Select Chatbot</div>
        <div class="flex flex-col gap-2">
          <label>
            <input type="radio" name="chatbot" value="Gemini" class="accent-black" checked />
            Gemini
          </label>
          <label>
            <input type="radio" name="chatbot" value="OpenAI" class="accent-black" />
            OpenAI
          </label>
          <label>
            <input type="radio" name="chatbot" value="Groq" class="accent-black" />
            Groq
          </label>
          <label>
            <input type="radio" name="chatbot" value="DeepSeek" class="accent-black" />
            DeepSeek
          </label>
        </div>
      </div>

      <div>
        <div class="text-[20px] font-medium">Select Writing Style</div>
        <div class="flex flex-col gap-2">
          <label>
            <input type="radio" name="writingStyle" value="child" class="accent-black" />
            Child
          </label>
          <label>
            <input type="radio" name="writingStyle" value="adult" class="accent-black" />
            Adult
          </label>
          <label>
            <input type="radio" name="writingStyle" value="professional" class="accent-black" />
            Professional
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="writingStyle" value="custom" class="accent-black" id="customStyleRadio" />
            Other:
            <input type="text" id="customStyleInput" class="border px-2 py-1 rounded text-sm"
              placeholder="Enter custom style" />
          </label>
        </div>
      </div>


      <div class="flex items-center">
        <div id="nextButton"
          class="plus-button inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem] mt-4">
          Next
        </div>
      </div>
    </div>
    <div class="flex flex-row justify-between min-h-[150px] h-[600px]">
      <div class="black flex justify-center w-full mt-4">
        <textarea id="scriptDisplay"
          class="scrollbar px-6 py-4 text-base text-center border border-black rounded-md min-h-[150px] w-[95%] max-w-[800px]"
          style="resize: vertical; white-space: pre-wrap;" placeholder="Your script will be displayed here..."
          readonly></textarea>
      </div>

      <div class="flex justify-center items-center mr-4">
        <button id="finishScriptBtn"
          class="plus-button inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem]">
          Finish Script
        </button>
      </div>
    </div>
  </div>


  <!-- Section to gen audio -->
  <div id="thirdPage" style="display: none;"
    class="fixed top-[3.8rem] sm:top-[5.4rem] left-[100px] h-[calc(100vh-5*1vh-3.8rem)] sm:h-[calc(100vh-5*1vh-7rem)] md:h-[calc(100vh-5*1vh-2rem)] w-[100%] md:w-[93%] bg-white rounded-[1rem] border border-[#ccc] overflow-y-auto overflow-x-hidden z-3">
    <div class="flex flex-row justify-between mx-4 my-auto gap-[3rem] py-[1rem]">
      <div class="flex items-center">
        <div id="returnScriptBtn"
          class="inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem] mt-4">
          Back
        </div>
      </div>

      <!-- Select engine TTS -->
      <div>
        <div class="text-[20px] font-medium">Select text-to-speech engine</div>
        <div class="flex flex-col gap-2 mt-2" id="ttsEngineGroup">
          <label>
            <input type="radio" name="ttsEngine" value="elevenlabs" class="accent-black" checked />
            ElevenLabs
          </label>
          <label>
            <input type="radio" name="ttsEngine" value="amazonpolly" class="accent-black" />
            Amazon Polly
          </label>
          <label>
            <input type="radio" name="ttsEngine" value="gtts" class="accent-black" />
            Google TTS (gTTS)
          </label>
        </div>
      </div>

      <!-- Select model/voice -->
      <div>
        <div class="text-[20px] font-medium">Select model / voice</div>
        <div class="flex flex-col gap-2 mt-2" id="voiceModelGroup">
          <!-- update with JavaScript -->
        </div>
      </div>

      <div class="flex items-center">
        <div id="audioButton"
          class="plus-button inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem] mt-4">
          Next
        </div>
      </div>
    </div>

    <!-- result audio -->
    <div id="audioResultTable" class="mx-4 mb-6">
      <div class="text-center mt-10 text-lg font-semibold">Your audio will be displayed here after generating successfully</div>

      <div class="flex justify-center items-center mr-4">
        <button id="finishAudioBtn"
          class="plus-button inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem]">
          Finish audio
        </button>
      </div>
    </div>

  </div>


  <!-- Section to gen media -->
  <div id="fourthPage" style="display: none;"
    class="fixed top-[3.8rem] sm:top-[5.4rem] left-[100px] h-[calc(100vh-5*1vh-3.8rem)] sm:h-[calc(100vh-5*1vh-7rem)] md:h-[calc(100vh-5*1vh-2rem)] w-[100%] md:w-[93%] bg-white rounded-[1rem] border border-[#ccc] overflow-y-auto overflow-x-hidden z-3">

    <div class="flex flex-row justify-between mx-4 my-auto gap-[3rem] py-[1rem]">
      <!-- Back button -->
      <div class="flex items-center">
        <div id="returnAudioBtn"
          class="inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem] mt-4">
          Back
        </div>
      </div>

      <div class="text-center mt-10 text-lg font-semibold">
        This is final step to generate a video 
      </div>

      <!-- empty button -->
      <div class="flex items-center"></div>
    </div>

    <!-- Media Table -->
    <div class="mt-10">
      <table class="min-w-full table-auto text-sm border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-4 py-2 text-left">ID</th>
            <th class="px-4 py-2 text-left">Text</th>
            <th class="px-4 py-2 text-left">Prompt</th>
            <th class="px-4 py-2 text-left">Action</th>
            <th class="px-4 py-2 text-left">Result</th>
          </tr>
        </thead>
        <tbody id="mediaTableBody">
        </tbody>
      </table>

      <!-- Finish Media Button -->
      <div class="text-center mt-6">
        <button id="finishMediaBtn" class="px-8 py-3 bg-blue-600 text-white rounded-full text-lg">Finish Media</button>
      </div>
    </div>
    
  </div>


  <div class="mx-4 my-auto items-center gap-[1rem] py-[1rem] text-[25px]">Hot topics</div>
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 gap-6 p-4">
    <div class="flex flex-col">
      <div class="w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden shadow" onclick="chooseTopic('Geology')">
        <img src="/img/assets/vidAILogo.png" alt="Preview" class="w-full h-full object-cover" />
      </div>
      <div class="flex justify-center mt-2 text-[15px] font-medium text-black truncate">Geology</div>
    </div>

    <div class="flex flex-col">
      <div class="w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden shadow" onclick="chooseTopic('Physics')">
        <img src="/img/assets/vidAILogo.png" alt="Preview" class="w-full h-full object-cover" />
      </div>
      <div class="flex justify-center mt-2 text-[15px] font-medium text-black truncate">Physics</div>
    </div>

    <div class="flex flex-col">
      <div class="w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden shadow" onclick="chooseTopic('Chemistry')">
        <img src="/img/assets/vidAILogo.png" alt="Preview" class="w-full h-full object-cover" />
      </div>
      <div class="flex justify-center mt-2 text-[15px] font-medium text-black truncate">Chemistry</div>
    </div>

    <div class="flex flex-col">
      <div class="w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden shadow" onclick="chooseTopic('Biology')">
        <img src="/img/assets/vidAILogo.png" alt="Preview" class="w-full h-full object-cover" />
      </div>
      <div class="flex justify-center mt-2 text-[15px] font-medium text-black truncate">Biology</div>
    </div>

    <div class="flex flex-col">
      <div class="w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden shadow" onclick="chooseTopic('Animal')">
        <img src="/img/assets/vidAILogo.png" alt="Preview" class="w-full h-full object-cover" />
      </div>
      <div class="flex justify-center mt-2 text-[15px] font-medium text-black truncate">Animal</div>
    </div>

    <div class="flex flex-col">
      <div class="w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden shadow" onclick="chooseTopic('War')">
        <img src="/img/assets/vidAILogo.png" alt="Preview" class="w-full h-full object-cover" />
      </div>
      <div class="flex justify-center mt-2 text-[15px] font-medium text-black truncate">War</div>
    </div>
  </div>
<form id="videoSyncForm" action="/Video/video-sync" method="POST">
  <input type="hidden" name="topic" id="topicInput">
  <input type="hidden" name="jsonPath" id="jsonPathInput">
  <button type="submit" style="display: none;">Gửi</button>
</form>


</div>

<script>
  const customRadio = document.getElementById("customStyleRadio");
  const customInput = document.getElementById("customStyleInput");

  // Disable input by default
  customInput.disabled = true;

  document.querySelectorAll('input[name="writingStyle"]').forEach(radio => {
    radio.addEventListener("change", () => {
      customInput.disabled = customRadio.checked ? false : true;
    });
  });

  document.getElementById("returnTopicBtn").addEventListener("click", function () {
    document.getElementById("secondPage").style.display = "none";
  });

  document.getElementById("returnScriptBtn").addEventListener("click", function () {
    document.getElementById("thirdPage").style.display = "none";
  });

  document.getElementById("returnAudioBtn").addEventListener("click", function () {
    document.getElementById("fourthPage").style.display = "none"; 
  });


  //handle choose model/voice
  const ttsVoiceModels = {
    elevenlabs: [
      { name: "Hale - EN/Male", value: "dXtC3XhB9GtPusIpNtQx" },
      { name: "Nichalia Schwartz - EN/Female", value: "XfNU2rGpBa01ckF309OY" },
      { name: "DangTungDuy - VI/Male", value: "3VnrjnYrskPMDsapTr8X" },
      { name: "Huyen - VI/Female", value: "foH7s9fX31wFFH2yqrFa" },
    ],
    amazonpolly: [
      { name: "Joanna - EN/Female", value: "Joanna" },
      { name: "Matthew - EN/Male", value: "Matthew" },
      { name: "Jihye - KOR/Female", value: "Jihye" },
      { name: "Daniel - GER/Male", value: "Daniel" },
    ],
    gtts: [
      { name: "en - English", value: "en" },
      { name: "en - English UK", value: "en-uk" },
      { name: "vi - Vietnamese", value: "vi" },
      { name: "es - Spanish", value: "es" },
    ],
  };

  const ttsRadios = document.querySelectorAll('input[name="ttsEngine"]');
  const voiceModelGroup = document.getElementById("voiceModelGroup");

  function renderVoiceModels(engine) {
    voiceModelGroup.innerHTML = "";

    const voices = ttsVoiceModels[engine] || [];
    voices.forEach((voice, index) => {
      const label = document.createElement("label");
      label.className = "flex gap-2 items-center min-w-[200px]";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "voiceModel";
      input.value = voice.value;
      input.className = "accent-black";

      if (index === 0) input.checked = true;

      label.appendChild(input);
      label.appendChild(document.createTextNode(voice.name));
      voiceModelGroup.appendChild(label);
    });

    if (voices.length === 0) {
      voiceModelGroup.innerHTML = "<div class='text-sm text-gray-500'>Không có giọng đọc tương ứng.</div>";
    }
  }

  ttsRadios.forEach((radio) => {
    radio.addEventListener("change", (e) => {
      renderVoiceModels(e.target.value);
    });
  });

  const defaultEngine = document.querySelector('input[name="ttsEngine"]:checked').value;
  renderVoiceModels(defaultEngine);


  // Handle button click
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("postButton").addEventListener("click", async function () {
      const topic = document.getElementById("insertTopic").value.trim();
      const duration = document.querySelector('input[name="duration"]:checked').value;

      if (!topic) {
        alert("Please enter a topic.");
        return;
      }
      if (!duration) {
        alert("Please select a duration.");
        return;
      }

      document.getElementById("secondPage").style.display = "block";

      // Pass the topic and duration to the next page as needed
      window.currentTopic = topic;
      window.currentDuration = duration;
    });

    // Handle script "Next" button click
    document.getElementById("nextButton").addEventListener("click", async function () {
      const selectedChatbot = document.querySelector('input[name="chatbot"]:checked')?.value;
      let selectedWritingStyles = document.querySelector('input[name="writingStyle"]:checked')?.value;
      const customInput = document.getElementById("customStyleInput");

      if (!selectedChatbot) {
        alert("Please select a chatbot.");
        return;
      }
      if (!selectedWritingStyles) {
        alert("Please select a writing style.");
        return;
      }
      console.log("Selected Chatbot:", selectedChatbot);
      console.log("Selected Writing Styles:", selectedWritingStyles);

      if (selectedWritingStyles === "custom") {
        const customStyle = customInput.value.trim();
        if (!customStyle) {
          alert("Please enter a custom writing style.");
          return;
        }
        selectedWritingStyles = customStyle;
      }

      const scriptDisplay = document.getElementById("scriptDisplay");
      scriptDisplay.setAttribute("readonly", "true");
      try {
        scriptDisplay.textContent = "In process...";

        const res = await fetch("/homepage/api/generate-script", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            topic: window.currentTopic,
            duration: window.currentDuration,
            chatbot: selectedChatbot,
            writingStyles: selectedWritingStyles,
          }),
        });

        const data = await res.json();

        if (data.success) {
          scriptDisplay.textContent = data.script;
          scriptDisplay.removeAttribute("readonly");
          scriptDisplay.scrollIntoView({ behavior: "smooth" }); // Optional: scroll to it
          window.currentScript = data.script; // later use in audio generation
        } else {
          scriptDisplay.textContent = "Error: " + data.message;
        }
      } catch (err) {
        console.error(err);
      }
    });


    //Handle finish script button click
    document.getElementById("finishScriptBtn").addEventListener("click", async function () {
      const script = document.getElementById("scriptDisplay").value.trim();
      if (!script) {
        alert("Please generate a script first.");
        return;
      }

      document.getElementById("thirdPage").style.display = "block";
      // Redirect to the next page or perform any action you want
      //window.location.href = "/homepage/gen-audio";
    });

    //Handle next audio btn click
    document.getElementById("audioButton").addEventListener("click", async function () {
      const selectedTtsEngine = document.querySelector('input[name="ttsEngine"]:checked')?.value;
      const selectedVoiceModel = document.querySelector('input[name="voiceModel"]:checked')?.value;
      const script = document.getElementById("scriptDisplay").value.trim();; 

      if (!selectedTtsEngine) {
        alert("Please select a TTS engine.");
        return;
      }
      if (!selectedVoiceModel) {
        alert("Please select a voice model.");
        return;
      }
      if (!script) {
        alert("Please generate a script first.");
        return;
      }

      try {
        const res = await fetch("/homepage/api/generate-audio", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            engine: selectedTtsEngine,
            voice: selectedVoiceModel,
            script: script,
          }),
        });

        const data = await res.json();

        if (data.success) {
          data.audios.forEach(segment => {
            console.log("Audio result:", segment.segmentTitle);
            segment.ideas.forEach(idea => {
              console.log("Text:", idea.text);
              console.log("Audio path:", idea.audioPath);
              console.log("Visual: ", idea.visual);
            });
          });

          updateAudioUI(data.audios);
          setupAudioButtons();
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error("Audio generation failed:", err);
        alert("Failed to generate audio. Please try again.");
      }
    });
    
    // Handle finish audio button click
    document.getElementById("finishAudioBtn").addEventListener("click", async function () {
      alert("Please generate audio files fully before proceeding."); 
    });  
  });


  function updateAudioUI(audioSegments) {
    const tableWrapper = document.getElementById("audioResultTable");
    tableWrapper.replaceChildren();

    let index = 1;
    let tableHTML = `
      <table class="w-full border border-gray-300 text-left text-sm">
        <thead>
          <tr class="bg-gray-100 font-semibold">
            <th class="border px-4 py-2 w-[5%]">#</th>
            <th class="border px-4 py-2 w-[55%]">Text</th>
            <th class="border px-4 py-2 w-[40%]">Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    audioSegments.forEach(segment => {
      segment.ideas.forEach(idea => {
        tableHTML += `
          <tr data-visual="${encodeURIComponent(idea.visual || "")}">
            <td class="border px-4 py-2">${index++}</td>
            <td class="border px-4 py-2">${idea.text}</td>
            <td class="border px-4 py-2">
              <div class="flex gap-4 items-center">
                <button class="play-btn px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600" data-audio="${idea.audioPath}">Play</button>
                <button class="record-btn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Record</button>
              </div>
            </td>
          </tr>
        `;
      });
    });

    tableHTML += `</tbody></table>
      <div class="flex justify-center items-center mr-4">
        <button id="finishAudioBtn"
          class="plus-button inline-block px-[2rem] py-[.6rem] font-medium cursor-pointer transition ease-in-out duration-300 text-sm hover:opacity-80 bg-white text-black border border-black border-solid rounded-[.7rem]">
          Finish audio
        </button>
      </div>`;
    tableWrapper.innerHTML = tableHTML;
  }

  function setupAudioButtons() {
    // Play audio btn
    let currentAudio = null;
    let currentButton = null;

    document.querySelectorAll(".play-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        // If another audio is already playing, pause that audio
        if (currentAudio && currentAudio !== btn.audioInstance) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          if (currentButton) {
            currentButton.textContent = "Play";
          }
        }

        // if there is no audio instance, create
        if (!btn.audioInstance) {
          btn.audioInstance = new Audio(btn.dataset.audio);
        }

        // If this audio is already playing, pause and reset
        if (!btn.audioInstance.paused) {
          btn.audioInstance.pause();
          btn.audioInstance.currentTime = 0;
          btn.textContent = "Play";
          currentAudio = null;
          currentButton = null;
        } else { 
          // play the audio
          btn.audioInstance.play();
          btn.textContent = "Stop";
          currentAudio = btn.audioInstance;
          currentButton = btn;

          // Reset the button text when the audio ends
          btn.audioInstance.onended = () => {
            btn.textContent = "Play";
            currentAudio = null;
            currentButton = null;
          };
        }
      });
    });


    // Record btn
    document.querySelectorAll(".record-btn").forEach((btn, index) => {
      let mediaRecorder = null;
      let audioChunks = [];
      let isRecording = false;
      let timerInterval = null;
      let seconds = 0;
      let timerEl = null;

      btn.addEventListener("click", async () => {
        if (!isRecording) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => {
              if (e.data.size > 0) {
                audioChunks.push(e.data);
              }
            };

            mediaRecorder.onstop = async () => {
              clearInterval(timerInterval);
              timerEl.remove();

              const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              audio.controls = true;

              const audioContainer = document.createElement('div');
              audioContainer.appendChild(audio);
              btn.parentElement.appendChild(audioContainer);

              // Gửi file về server
              const formData = new FormData();
              formData.append('audio', audioBlob, `recording_${index}.webm`);

              const response = await fetch('/Homepage/upload-recording', {
                method: 'POST',
                body: formData
              });
              const result = await response.json();

              if (result.success) {
                console.log("Audio uploaded to server!");
                btn.dataset.recordedUrl = result.path.replace('/src/', ''); // chỉ tên file 
                btn.dataset.duration = seconds.toString(); // thời lượng
              } else {
                console.error("Upload failed.");
              }
            };

            // Timer hiển thị
            timerEl = document.createElement('span');
            timerEl.className = "ml-2 text-xs text-white bg-red-500 px-2 py-1 rounded";
            timerEl.textContent = "00:00";
            btn.parentElement.appendChild(timerEl);

            seconds = 0;
            timerInterval = setInterval(() => {
              seconds++;
              const m = String(Math.floor(seconds / 60)).padStart(2, '0');
              const s = String(seconds % 60).padStart(2, '0');
              timerEl.textContent = `${m}:${s}`;
            }, 1000);

            mediaRecorder.start();
            isRecording = true;
            btn.textContent = "Stop Recording";
          } catch (err) {
            console.error("Mic permission denied or error:", err);
            alert("Failed to access microphone.");
          }
        } else {
          mediaRecorder.stop();
          isRecording = false;
          btn.textContent = "Record";
        }
      });
    });

    // Handle finish audio button click
    document.getElementById("finishAudioBtn").addEventListener("click", async function () {
      const finalJson = await generateFinalJson();
      console.log("Final JSON:", JSON.stringify(finalJson, null, 2));
      const allHaveAudio = finalJson.every(item => item.audioUrl && item.audioUrl.trim() !== "");

      if (!allHaveAudio) {
        alert("Please generate audio files fully before proceeding.");
        return;
      }

      document.getElementById("fourthPage").style.display = "block";
      window.jsonData = finalJson; 
      finishMedia();
    });  
  }
  // Save every data except image/vid to JSON
    async function generateFinalJson() {
      const rows = document.querySelectorAll("tbody tr");
      const result = [];
      let startTime = 0;

      for (const row of rows) {
        const text = row.querySelector("td:nth-child(2)").innerText.trim();
        const playBtn = row.querySelector(".play-btn");
        const recordBtn = row.querySelector(".record-btn");
        const visual = decodeURIComponent(row.dataset.visual || "");

        const hasRecorded = recordBtn.dataset.recordedUrl;
        const audioUrl = hasRecorded ? `/src/${recordBtn.dataset.recordedUrl}` : playBtn.dataset.audio;

        let duration = hasRecorded ? parseFloat(recordBtn.dataset.duration) : null;

        if (!hasRecorded) {
          // Lấy duration từ audio gốc
          duration = await getAudioDuration(audioUrl);
        }

        result.push({
          start: startTime,
          duration: duration,
          audioUrl: audioUrl,
          src: "",
          content: text,
          visual: visual,
        });

        startTime += duration;
      }

      console.log("Final JSON:", JSON.stringify(result, null, 2));
      return result;
    }
  // Hàm phụ để lấy thời lượng file audio
  function getAudioDuration(url) {
    return new Promise((resolve) => {
      const audio = new Audio(url);
      audio.addEventListener('loadedmetadata', () => {
        resolve(audio.duration);
      });
      audio.addEventListener('error', () => {
        console.error("Error loading audio metadata:", url);
        resolve(6); // fallback nếu lỗi
      });
    });
  }


  // fourth page
  const tableBody = document.getElementById('mediaTableBody');
  const resultTableBody = document.getElementById('resultTableBody');

  tableBody.addEventListener('click', function (event) {
    const target = event.target;
    const jsonData = window.jsonData || [];

    // click "+"
    if (target.classList.contains('add-row')) {
      const row = target.closest('tr');
      const content = row.children[1].textContent;
      const duration = parseFloat(jsonData.find(item => item.content === content)?.duration || 0);

      const currentCount = Array.from(tableBody.querySelectorAll('tr')).filter(tr =>
        tr.children[1] && tr.children[1].textContent === content
      ).length;

      if ((currentCount + 1) * 5 > duration) {
        alert('Cannot add more rows for this content. The duration is limited.');
        return;
      }

      // Clone hàng và loại bỏ các phần không cần (img, nút convert nếu có)
      const newRow = row.cloneNode(true);
      
      // Reset input
      const input = newRow.querySelector('input');
      if (input) input.value = '';

      // Xoá ảnh kết quả nếu có
      const img = newRow.querySelector('img');
      if (img) img.remove();

      // Xoá nút "Convert to Image/Video"
      const convertBtn = newRow.querySelector('.convert-to-video, .convert-to-image');
      if (convertBtn) convertBtn.remove();

      // Xoá nút "-" cũ nếu có
      const oldRemoveBtn = newRow.querySelector('.remove-row');
      if (oldRemoveBtn) oldRemoveBtn.remove();

      // Thêm nút "-"
      const removeButton = document.createElement('button');
      removeButton.textContent = '-';
      removeButton.className = 'remove-row px-4 py-2 bg-red-500 text-white rounded ml-2';
      newRow.querySelector('td:nth-child(4)').appendChild(removeButton);

      tableBody.appendChild(newRow);
    }

    // click "-"
    if (target.classList.contains('remove-row')) {
      target.closest('tr').remove();
    }

    // handle "Convert to Video"
    if (target.classList.contains('convert-to-video')) {
      const row = target.closest('tr');
      const content = row.children[1].textContent;

      // Xoá tất cả dòng có cùng content
      Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
        if (tr.children[1] && tr.children[1].textContent === content && tr !== row) {
          tr.remove();
        }
      });

      // Xoá nút "+"
      const addBtn = row.querySelector('.add-row'), 
            removeBtn = row.querySelector('.remove-row');
      if (addBtn) addBtn.remove();
      if (removeBtn) removeBtn.remove();

      // Đổi text nút
      target.textContent = 'Convert to Image';
      target.classList.remove('convert-to-video');
      target.classList.add('convert-to-image');
      target.classList.remove('bg-blue-500');
      target.classList.add('bg-yellow-500');

    } else if (target.classList.contains('convert-to-image')) {
      const row = target.closest('tr');
      const content = row.children[1].textContent;

      // add "+"
      const addBtn = document.createElement('button');
      addBtn.textContent = '+';
      addBtn.className = 'add-row px-4 py-2 bg-green-500 text-white rounded ml-2';

      const lastTd = row.querySelector('td:nth-child(4)');
      if (lastTd) lastTd.appendChild(addBtn);

      target.textContent = 'Convert to Video';
      target.classList.remove('convert-to-image');
      target.classList.add('convert-to-video');
      target.classList.remove('bg-yellow-500');
      target.classList.add('bg-blue-500');

      // Lấy ảnh thật từ cột "Result"
      const img = row.querySelector('td:last-child img');
      const imgSrc = img ? img.src : 'https://placehold.co/100x60?text=Image';

      const resultTableBody = document.querySelector('#result-table tbody');
      if (resultTableBody) {
        const resultRow = document.createElement('tr');
        resultRow.innerHTML = `
          <td class="px-4 py-2">Image</td>
          <td class="px-4 py-2">${content}</td>
          <td class="px-4 py-2"><img src="${imgSrc}" alt="image-preview" class="w-24 h-auto rounded"/></td>
        `;
        resultTableBody.appendChild(resultRow);
      }
    }


    // Khi click "Generate"
    if (target.classList.contains('generate-result')) {
      const row = target.closest('tr');
      const content = row.children[1].textContent;
      const prompt = row.querySelector('input').value;

      if (!prompt) {
        alert( `Please enter a prompt for ${content}`);
        return;
      }

      // Kiểm tra trạng thái dòng hiện tại
      const convertBtn = row.querySelector('.convert-to-image, .convert-to-video');

      let apiUrl = '';
      if (convertBtn && convertBtn.classList.contains('convert-to-image')) {
        apiUrl = '/Homepage/api/generate-video';
      } else {
        apiUrl = '/Homepage/api/generate-image';
      }

      // Fetch dữ liệu
      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ prompt })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success || !data.path) {
          alert('Không nhận được kết quả từ server!');
          return;
        }

        const resultCell = row.querySelector('td:nth-child(5)');
        resultCell.replaceChildren(); 

        if (apiUrl.includes('video')) {
          resultCell.innerHTML = `<video controls width="150"><source src="${data.path}" type="video/mp4"></video>`;
        } else {
          resultCell.innerHTML = `<img src="${data.path}" class="w-[150px] h-auto rounded" />`;
        }
      })
      .catch(err => {
        console.error('Error fetching result:', err);
        alert('Error calling API!');
      });
    }     
  });

  function finishMedia() {
    const jsonData = window.jsonData;
    tableBody.innerHTML = '';

    jsonData.forEach((item, index) => {
      const id = index + 1;
      const row = document.createElement('tr');

      const idCell = document.createElement('td');
      idCell.className = 'px-4 py-2';
      idCell.textContent = id;

      const textCell = document.createElement('td');
      textCell.className = 'px-4 py-2';
      textCell.textContent = item.content;

      const promptCell = document.createElement('td');
      promptCell.className = 'px-4 py-2';
      const promptInput = document.createElement('input');
      promptInput.type = 'text';
      promptInput.className = 'w-full border border-gray-300 p-2 rounded';
      promptInput.value = item.visual;
      promptCell.appendChild(promptInput);

      const actionCell = document.createElement('td');
      actionCell.className = 'px-4 py-2 text-center';

      const convertBtn = document.createElement('button');
      convertBtn.className = 'convert-to-video px-4 py-2 bg-blue-500 text-white rounded';
      convertBtn.textContent = 'Convert to Video';

      const addBtn = document.createElement('button');
      addBtn.className = 'add-row px-4 py-2 bg-green-500 text-white rounded ml-2';
      addBtn.textContent = '+';

      const generateBtn = document.createElement('button');
      generateBtn.className = 'generate-result px-4 py-2 bg-purple-500 text-white rounded ml-2';
      generateBtn.textContent = 'Generate';

      actionCell.appendChild(convertBtn);
      actionCell.appendChild(generateBtn);
      actionCell.appendChild(addBtn);

      const resultCell = document.createElement('td');
      resultCell.className = 'px-4 py-2 text-center';

      if (item.src) {
        const img = document.createElement('img');
        img.src = item.src;
        img.alt = `Image ${id}`;
        img.className = 'w-32 h-auto rounded mx-auto';
        resultCell.appendChild(img);
      }

      row.appendChild(idCell);
      row.appendChild(textCell);
      row.appendChild(promptCell);
      row.appendChild(actionCell);
      row.appendChild(resultCell);
      tableBody.appendChild(row);
    });
  }

  document.getElementById('finishMediaBtn').addEventListener('click', () => {
    const rows = document.querySelectorAll('#mediaTableBody tr');
    console.log('Rows:', rows);

    rows.forEach(row => {
      const content = row.children[1].textContent.trim();
      const mediaCell = row.children[4];

      let src = '';
      const img = mediaCell.querySelector('img');
      const video = mediaCell.querySelector('video > source');

      if (img) {
        src = img.src;
      } else if (video) {
        src = video.src;
      }

      if (!src) return; 

      const item = window.jsonData.find(item => item.content === content);
      if (item) {
        item.src = src;
      }
    });

    // every item must have src
    const missing = window.jsonData.filter(item => !item.src);
    if (missing.length > 0) {
      alert(`Missing ${missing.length} media! Please check again.`);
      console.warn('Missing item:', missing);
      return;
    }

    console.log('✅ Tất cả src đã đầy đủ:', window.jsonData);
      // Gửi trực tiếp tới server
  const form = document.getElementById('videoSyncForm');
  document.getElementById('topicInput').value = window.currentTopic;
  document.getElementById('jsonPathInput').value = JSON.stringify(window.jsonData);

  form.submit(); // ✅ Điều hướng thật đến /Video/video-sync
  });

  function chooseTopic(topic) {
    console.log("Topic chosen:", topic);
    // Lấy textarea có id="insertTopic"
    const topicInput = document.getElementById("insertTopic");
    // Điền topic vào textarea
    topicInput.value = topic;
    // Tùy chọn: Tự động điều chỉnh chiều cao của textarea
    topicInput.style.height = '';
    topicInput.style.height = topicInput.scrollHeight + 'px';
}
</script>